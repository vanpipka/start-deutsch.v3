{% extends "core/base.html" %}
{% load dict_extras %}
{% block content %}

<div class="max-w-5xl mx-auto px-4 py-10">

  {# Breadcrumbs #}
    <nav class="text-sm text-gray-500 mb-4" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-2">
            {% for crumb in breadcrumbs %}
                <li class="inline-flex items-center">
                    {% if crumb.url %}
                        <a href="{{ crumb.url }}" class="text-blue-600 hover:underline">{{ crumb.title }}</a>
                        <svg class="w-4 h-4 mx-1 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path d="M7.05 14.95a.5.5 0 0 0 .7 0l5-5a.5.5 0 0 0 0-.7l-5-5a.5.5 0 1 0-.7.7L11.29 10l-4.24 4.24a.5.5 0 0 0 0 .7z"/></svg>
                    {% else %}
                        <span class="text-gray-700 font-medium">{{ crumb.title }}</span>
                    {% endif %}
                </li>
            {% endfor %}
        </ol>
    </nav>

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —ç–∫–∑–∞–º–µ–Ω–∞ -->
  <div class="mb-8">
    <h1 class="text-2xl font-semibold text-gray-900">
      {{ seo_title }}
    </h1>
    <p class="text-sm text-gray-500 mt-1">
      –†–µ–∑—É–ª—å—Ç–∞—Ç —ç–∫–∑–∞–º–µ–Ω–∞ ¬∑ {{ attempt.started_at|date:"d.m.Y H:i" }}
    </p>
  </div>

  <!-- –ò—Ç–æ–≥ —ç–∫–∑–∞–º–µ–Ω–∞ -->
  <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 mb-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <p class="text-gray-500 text-sm">–ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
        <p class="text-2xl font-semibold text-gray-900">
          {{ attempt.total_score }} / {{ attempt.total_questions }}
        </p>
      </div>

      <div class="text-sm text-gray-500">
        –ó–∞–≤–µ—Ä—à—ë–Ω:
        {{ attempt.finished_at|date:"d.m.Y H:i" }}
      </div>
    </div>
  </div>

  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ç–µ—Å—Ç–∞–º -->
  {% for test_result in attempt.test_results.all %}
    <div class="bg-white border border-gray-200 rounded-xl shadow-sm mb-8">

      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ—Å—Ç–∞ -->
      <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
        <h2 class="font-medium text-gray-900">
          {{ test_result.test.title }}
        </h2>
        <span class="text-sm font-semibold text-blue-700 bg-blue-100 px-3 py-1 rounded-full">
          {{ test_result.score }} / {{ test_result.total }}
        </span>
      </div>

      <!-- –í–æ–ø—Ä–æ—Å—ã -->
      <div class="p-6 space-y-6">
        {% for ua in answers_by_test|get_item:test_result.test %}
          <div>

            <!-- –¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ -->
            <p class="font-medium text-gray-900 mb-2">
              {{ ua.question.text }}
            </p>

            <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ -->
            {% if ua.question.image %}
              <img src="{{ ua.question.image.url }}"
                   class="rounded-lg mb-3 max-h-64">
            {% endif %}

            <!-- –ê—É–¥–∏–æ -->
            {% if ua.question.audio %}
              <audio controls class="w-full mb-3">
                <source src="{{ ua.question.audio.url }}">
              </audio>
            {% endif %}

            <!-- –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="text-sm mb-2">
              <span class="text-gray-500">–í–∞—à –æ—Ç–≤–µ—Ç:</span>

              {% if ua.question.test.is_yes_no %}
                {% if ua.yes_no_answer %}
                  <span class="ml-2 inline-flex items-center px-2 py-1 rounded
                               bg-blue-100 text-blue-700 font-medium">
                    –î–∞
                  </span>
                {% else %}
                  <span class="ml-2 inline-flex items-center px-2 py-1 rounded
                               bg-gray-100 text-gray-700 font-medium">
                    –ù–µ—Ç
                  </span>
                {% endif %}
              {% else %}
                <span class="ml-2 inline-flex items-center px-2 py-1 rounded
                             bg-blue-100 text-blue-700 font-medium">
                  {{ ua.selected_answer.text }}
                </span>
              {% endif %}
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
            {% if ua.is_correct %}
              <span class="inline-flex items-center gap-1
                           text-green-700 bg-green-100
                           px-3 py-1 rounded-full text-sm font-medium">
                ‚úî –í–µ—Ä–Ω–æ
              </span>
            {% else %}
              <span class="inline-flex items-center gap-1
                           text-red-700 bg-red-100
                           px-3 py-1 rounded-full text-sm font-medium">
                ‚úò –ù–µ–≤–µ—Ä–Ω–æ
              </span>

              {% with correct=ua.question.get_correct_answer %}
                <p class="mt-2 text-sm text-green-700">
                  –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:
                  <strong>{{ correct.text }}</strong>
                </p>
              {% endwith %}
            {% endif %}

          </div>

          <hr class="border-gray-100">
        {% endfor %}
      </div>

    </div>
  {% endfor %}

  {# Related attempts/internal linking #}
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">

        {% for exam in related_exams %}
            <div class="bg-white rounded-2xl shadow hover:shadow-xl transition p-6 flex flex-col">

                <h3 class="text-xl font-semibold mb-2">
                    {{ exam.title }}
                </h3>

                {% if exam.description %}
                    <p class="text-gray-600 text-sm mb-4 flex-grow">
                        {{ exam.description|truncatechars:120 }}
                    </p>
                {% endif %}

                <div class="text-sm text-gray-500 mb-4">
                    üìù –¢–µ—Å—Ç–æ–≤: <span class="font-medium">{{ exam.tests_count }}</span>
                </div>

                <div class="mt-auto flex items-center justify-between">
                        <a href="{% url 'tests:exam_detail' exam.id %}"
                            class="inline-flex items-center text-sm text-white bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                –ù–∞—á–∞—Ç—å
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </a>
                </div>

            </div>
        {% empty %}
            <p>–≠–∫–∑–∞–º–µ–Ω–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
        {% endfor %}

    </div>


  <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
  <div class="text-center mt-10">
    <a href="{% url 'tests:exam_attempt_list' %}"
       class="inline-flex items-center gap-2
              text-blue-600 hover:text-blue-800
              font-medium">
      ‚Üê –ú–æ–∏ –ø–æ–ø—ã—Ç–∫–∏
    </a>
  </div>

</div>

{% endblock %}
